name: Test Jumpstarter Setup

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test-jumpstarter-setup:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Install dependencies
      run: |
        # Install Kind
        [ $(uname -m) = x86_64 ] && curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
        [ $(uname -m) = aarch64 ] && curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-arm64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind
        
        # Install kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # Install Helm
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        
        # Install uv for Python dependencies
        curl -LsSf https://astral.sh/uv/install.sh | sh
        source ~/.cargo/env
        echo "~/.cargo/bin" >> $GITHUB_PATH

    - name: Create Kind cluster
      run: |
        echo "ğŸš€ Creating Kind cluster for Jumpstarter..."
        kind create cluster --config kind-config.yaml --wait 300s
        kubectl cluster-info
        kubectl get nodes

    - name: Install NGINX Ingress
      run: |
        echo "ğŸ“¡ Installing NGINX Ingress Controller..."
        kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
        kubectl wait --namespace ingress-nginx \
          --for=condition=ready pod \
          --selector=app.kubernetes.io/component=controller \
          --timeout=300s

    - name: Install Jumpstarter via Helm
      run: |
        echo "âš¡ Installing Jumpstarter via Helm..."
        helm repo add jumpstarter https://jumpstarter-dev.github.io/jumpstarter
        helm repo update
        helm install jumpstarter jumpstarter/jumpstarter \
          --namespace jumpstarter-lab \
          --create-namespace \
          --wait --timeout=300s \
          --set controller.nodePort=30010 \
          --set router.nodePort=30011 \
          --set ingress.enabled=true \
          --set ingress.hosts[0].host=jumpstarter.127.0.0.1.nip.io \
          --set ingress.hosts[0].paths[0].path=/ \
          --set ingress.hosts[0].paths[0].pathType=Prefix

    - name: Wait for Jumpstarter to be ready
      run: |
        echo "â³ Waiting for Jumpstarter pods to be ready..."
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=jumpstarter-controller -n jumpstarter-lab --timeout=300s
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=jumpstarter-router -n jumpstarter-lab --timeout=300s
        
        echo "ğŸ“Š Jumpstarter pod status:"
        kubectl get pods -n jumpstarter-lab
        
        echo "ğŸ” Service status:"
        kubectl get svc -n jumpstarter-lab

    - name: Set up Python environment
      run: |
        echo "ğŸ Setting up Python environment with uv..."
        source ~/.cargo/env
        
        echo "ğŸ“¦ Installing dependencies from pyproject.toml..."
        uv sync
        
        echo "âœ… Python environment ready"
        uv run python --version

    - name: Configure DNS for testing
      run: |
        echo "ğŸŒ Configuring DNS for nip.io domains..."
        echo "127.0.0.1 grpc.jumpstarter.127.0.0.1.nip.io" | sudo tee -a /etc/hosts
        echo "127.0.0.1 router.jumpstarter.127.0.0.1.nip.io" | sudo tee -a /etc/hosts
        echo "127.0.0.1 jumpstarter.127.0.0.1.nip.io" | sudo tee -a /etc/hosts
        
        echo "ğŸ§ª Testing DNS resolution:"
        nslookup grpc.jumpstarter.127.0.0.1.nip.io || true
        ping -c 1 grpc.jumpstarter.127.0.0.1.nip.io || true

    - name: Test basic connectivity
      run: |
        echo "ğŸ”Œ Testing basic Jumpstarter connectivity..."
        
        # Test Kubernetes services are running
        kubectl get pods -n jumpstarter-lab
        kubectl get svc -n jumpstarter-lab
        
        # Test that services have endpoints
        kubectl get endpoints -n jumpstarter-lab
        
        echo "âœ… Basic connectivity tests completed"

    - name: Create and test Mock Exporter
      run: |
        echo "ğŸ¤– Testing Jumpstarter CLI functionality..."
        
        # Test that CLI is working
        echo "ğŸ” Testing admin CLI commands..."
        uv run jmp admin --help
        uv run jmp admin version
        
        # Test get command (updated from deprecated 'list')
        echo "ï¿½ Testing admin get commands..."
        uv run jmp admin get --help
        
        echo "âœ… CLI functionality verified"

    - name: Robot Framework Test
      run: |
        echo "ğŸ¤– Running Robot Framework integration tests..."
        
        # Use the same make target as local development
        echo "ğŸ¤– Executing Robot Framework tests via Makefile..."
        make test-robot

    - name: Upload Robot Framework results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: robot-test-results
        path: tests/robot/results/
        retention-days: 30

    - name: Collect logs on failure
      if: failure()
      run: |
        echo "ğŸ’¥ Test failed - collecting debug information..."
        
        echo "=== Kubernetes Cluster Info ==="
        kubectl cluster-info
        
        echo "=== All Pods ==="
        kubectl get pods --all-namespaces
        
        echo "=== Jumpstarter Pods Logs ==="
        kubectl logs -n jumpstarter-lab -l app.kubernetes.io/name=jumpstarter-controller --tail=100 || true
        kubectl logs -n jumpstarter-lab -l app.kubernetes.io/name=jumpstarter-router --tail=100 || true
        
        echo "=== Services ==="
        kubectl get svc --all-namespaces
        
        echo "=== Ingress ==="
        kubectl get ingress --all-namespaces
        
        echo "=== Events ==="
        kubectl get events --all-namespaces --sort-by='.lastTimestamp' --tail=50

    - name: Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up test environment..."
        kind delete cluster || true
